{"version":3,"file":"index.js","sources":["../lib/bufferCutter.js"],"sourcesContent":["import stream from 'stream';\n\nexport function cutBuffer(buf, opts = {}) {\n  if (!(buf instanceof Buffer)) {\n    throw new Error(`${buf} is not Buffer`);\n  }\n\n  const deepCopy = 'deepCopy' in opts ? opts.deepCopy : true;\n  const start = 'start' in opts ? opts.start : 0;\n  const end = 'end' in opts ? opts.end : buf.length;\n  const length = buf.length < end ? buf.length - start : end - start;\n\n  if (deepCopy) {\n    const result = Buffer.alloc(length);\n    buf.copy(result, 0, start, start + length);\n    return result;\n  }\n\n  return buf.subarray(start, start + length);\n}\n\nexport function cuttingBuffer(buffer, opts = {}) {\n  if (!(buffer instanceof Buffer)) {\n    throw new Error(`${buffer} is not Buffer`);\n  }\n\n  const result = [];\n\n  const deepCopy = 'deepCopy' in opts ? opts.deepCopy : true;\n  const length = 'length' in opts ? opts.length : buffer.length;\n\n  for (let i = 0; i < buffer.length; ) {\n    result.push(cutBuffer(buffer, { deepCopy, start: i, end: (i += length) }));\n  }\n\n  return result;\n}\n\nexport async function* cuttingRStream(readable, opts = {}) {\n  if (!(readable instanceof stream.Readable)) {\n    throw new Error(`${readable} is not Readable Stream`);\n  }\n\n  const deepCopy = 'deepCopy' in opts ? opts.deepCopy : true;\n  const length = 'length' in opts ? opts.length : null;\n  if (length === null) {\n    throw new Error('no unit to cut');\n  }\n\n  let tmpBuffers = [];\n  let tmpTotalSize = 0;\n  // eslint-disable-next-line no-restricted-syntax\n  for await (const chunk of readable) {\n    tmpBuffers.push(chunk);\n    tmpTotalSize += chunk.length;\n\n    if (tmpTotalSize > length) {\n      const buffers = cuttingBuffer(Buffer.concat(tmpBuffers), {\n        deepCopy,\n        length,\n      });\n      const isRest = buffers.length % length !== 0;\n      const loopTimes = isRest ? buffers.length - 1 : buffers.length;\n      for (let i = 0; i < loopTimes; i += 1) {\n        yield buffers[i];\n      }\n\n      if (isRest) {\n        tmpBuffers = [buffers[buffers.length - 1]];\n        tmpTotalSize = tmpBuffers.reduce((sum, buf) => sum + buf.length, 0);\n      } else {\n        tmpBuffers = [];\n        tmpTotalSize = 0;\n      }\n    }\n  }\n  if (tmpBuffers.length > 0) yield* tmpBuffers;\n}\n"],"names":["cutBuffer","buf","opts","Buffer","Error","deepCopy","start","end","length","result","alloc","copy","subarray","cuttingBuffer","buffer","i","push","cuttingRStream","readable","stream","Readable","tmpBuffers","tmpTotalSize","chunk","buffers","concat","isRest","loopTimes","reduce","sum"],"mappings":"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"}